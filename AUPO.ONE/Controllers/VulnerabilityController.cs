using Application.Features.Vulnerability.Queries.FirstTask;
using Application.Features.Vulnerability.Queries.SecondTask;
using Application.Features.Vulnerability.Queries.ThirdTask;
using Infrastructure.Services;
using MediatR;
using Microsoft.AspNetCore.Mvc;


namespace Wep.API.Controllers;

[ApiController]
[Route("[controller]")]
public class VulnerabilityController : ControllerBase
{
    private readonly IMediator _mediator;

    public VulnerabilityController(IMediator mediator)
    {
        _mediator = mediator ?? throw new ArgumentNullException(nameof(mediator));
    }

    [HttpPost("[action]")]
    public async Task<IActionResult> FirstTask(IFormFile file)
    {
        byte[] byteArray;

        using (var memoryStream = new MemoryStream())
        {
            file.CopyTo(memoryStream);
            byteArray = memoryStream.ToArray();
        }

        var vulnerabilities = await _mediator.Send(new VulnerabilityFirstTaskQuery(byteArray));

        return File(vulnerabilities, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", "vulnerabilities.xlsx");
    }

    [HttpPost("[action]")]
    public async Task<IActionResult> SecondTask(IFormFile file)
    {
        byte[] byteArray;

        using (var memoryStream = new MemoryStream())
        {
            file.CopyTo(memoryStream);
            byteArray = memoryStream.ToArray();
        }

        var vulnerabilities = await _mediator.Send(new VulnerabilitySecondTaskQuery(byteArray));

        return File(vulnerabilities, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", "vulnerabilities.xlsx");
    }

    [HttpPost("[action]")]
    public async Task<IActionResult> ThirdTask(IFormFile file)
    {
        byte[] byteArray;

        using (var memoryStream = new MemoryStream())
        {
            file.CopyTo(memoryStream);
            byteArray = memoryStream.ToArray();
        }

        var vulnerabilities = await _mediator.Send(new VulnerabilityThirdTaskQuery(byteArray));

        return File(vulnerabilities, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", "vulnerabilities.xlsx");
    }

    [HttpPost("[action]")]
    public async Task<IActionResult> FourTask(IFormFile file)
    {
        return Ok();
    }
}
